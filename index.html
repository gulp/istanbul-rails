<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Istanbul Rail Network - Cytoscape</title>
<script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
<!-- For fcose layout -->
<script src="https://unpkg.com/layout-base@2.0.1/layout-base.js"></script>
<script src="https://unpkg.com/cose-base@2.1.0/cose-base.js"></script>
<script src="https://unpkg.com/cytoscape-fcose@2.2.0/cytoscape-fcose.js"></script>
<style>
  body { font-family: sans-serif; margin: 0; padding: 0; }
  #cy {
    width: 100vw;
    height: 100vh;
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 999;
  }
  #info {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(255, 255, 255, 0.8);
    padding: 10px;
    border-radius: 5px;
    z-index: 1000;
    max-width: 300px;
  }
</style>
</head>
<body>

  <div id="info">
    <h2>Istanbul Rail Network</h2>
    <p>Displaying a force-directed layout.</p>
    <p>Click on a station to see its ID.</p>
    <pre id="station-info"></pre>
  </div>
  <div id="cy"></div>

<script>
  // Register the fcose layout
  cytoscape.use(cytoscapeFcose);

  // Your consolidated JSON data
  // I'm using the M2 example data directly here.
  // In a real app, you'd fetch this from a .json file or an API.
  const railData = {
    "stations": [
      {"id": "sefako_y", "name": "Sefaköy", "district": "Küçükçekmece", "lines": ["M2"], "transfers": ["M20", "METROBUS"], "notes": null, "type": "Underground"},
      {"id": "c_obanc_es_me", "name": "Çobançeşme", "district": "Bahçelievler", "lines": ["M2"], "transfers": ["M9"], "notes": "Kuyumcukent・...", "type": null},
      {"id": "zafer", "name": "Zafer", "district": "Bahçelievler", "lines": ["M2"], "transfers": [], "notes": null, "type": null},
      {"id": "siyavus_pas_a", "name": "Siyavuşpaşa", "district": "Bahçelievler", "lines": ["M2"], "transfers": [], "notes": null, "type": null},
      {"id": "adnan_kahveci", "name": "Adnan Kahveci", "district": "Bahçelievler", "lines": ["M2"], "transfers": [], "notes": null, "type": null},
      {"id": "i_ncirli", "name": "İncirli", "district": "Bakırköy", "lines": ["M2"], "transfers": ["M1A", "M3", "METROBUS"], "notes": "Bakirkoy Palace of Justice...", "type": null},
      {"id": "osmaniye", "name": "Osmaniye", "district": "Bakırköy", "lines": ["M2"], "transfers": [], "notes": null, "type": null},
      {"id": "zeytinburnu_adliye", "name": "Zeytinburnu Adliye", "district": "Zeytinburnu", "lines": ["M2"], "transfers": [], "notes": "Zeytinburnu Square", "type": null},
      {"id": "silivrikapi", "name": "Silivrikapı", "district": "Fatih", "lines": ["M2"], "transfers": [], "notes": null, "type": null},
      {"id": "kocamustafapas_a", "name": "Kocamustafapaşa", "district": "Fatih", "lines": ["M2"], "transfers": [], "notes": "Istanbul University - Cerrahpaşa", "type": null},
      {"id": "yenikapi", "name": "Yenikapı", "district": "Fatih", "lines": ["M2"], "transfers": ["M1", "MARMARAY", "T6", "FERRY"], "notes": "Aksaray Tram Station 750m Walking (T1 connection implied).", "type": "Underground"},
      {"id": "vezneciler", "name": "Vezneciler", "district": "Fatih", "lines": ["M2"], "transfers": ["T1"], "notes": "[Istanbul University] ...", "type": null},
      {"id": "halic_", "name": "Haliç", "district": "Fatih", "lines": ["M2"], "transfers": ["T5"], "notes": "[Haliç Metro Bridge] ...", "type": "Bridge"},
      {"id": "s_is_hane", "name": "Şişhane", "district": "Beyoğlu", "lines": ["M2"], "transfers": ["F2", "T2"], "notes": "[İstiklal Avenue] ...", "type": "Underground"},
      {"id": "taksim", "name": "Taksim", "district": "Beyoğlu", "lines": ["M2"], "transfers": ["F1", "T2", "TF1"], "notes": "[Taksim Square] ...", "type": null},
      {"id": "osmanbey", "name": "Osmanbey", "district": "Şişli", "lines": ["M2"], "transfers": [], "notes": "[Pangaltı] ...", "type": null},
      {"id": "s_is_li___mecidiyeko_y", "name": "Şişli - Mecidiyeköy", "district": "Şişli", "lines": ["M2"], "transfers": ["M7", "METROBUS"], "notes": "[Cevahir AVM] ...", "type": null},
      {"id": "gayrettepe", "name": "Gayrettepe", "district": "Beşiktaş & Şişli", "lines": ["M2"], "transfers": ["M11", "METROBUS"], "notes": "[Zincirlikuyu] ...", "type": null},
      {"id": "levent", "name": "Levent", "district": "Beşiktaş & Şişli", "lines": ["M2"], "transfers": ["M6"], "notes": "[Metrocity] ...", "type": null},
      {"id": "4_levent", "name": "4. Levent", "district": "Kâğıthane & Beşiktaş", "lines": ["M2"], "transfers": ["M34"], "notes": "[Istanbul Sapphire] ...", "type": null},
      {"id": "sanayi_mahallesi", "name": "Sanayi Mahallesi", "district": "Sarıyer", "lines": ["M2"], "transfers": ["M2S"], "notes": "M2 Shuttle Metro Line (free)...", "type": null},
      {"id": "i_tu_ayazag_a", "name": "İTÜ–Ayazağa", "district": "Sarıyer", "lines": ["M2"], "transfers": ["F5"], "notes": "[Istanbul Technical University (İTÜ) Ayazağa Campus] ...", "type": null},
      {"id": "atatu_rk_oto_sanayi", "name": "Atatürk Oto Sanayi", "district": "Sarıyer", "lines": ["M2"], "transfers": [], "notes": "Vodafone Station (Sponsor)", "type": null},
      {"id": "daru_s_s_afaka", "name": "Darüşşafaka", "district": "Sarıyer", "lines": ["M2"], "transfers": [], "notes": "[Darüşşafaka] ...", "type": null},
      {"id": "haciosman", "name": "Hacıosman", "district": "Sarıyer", "lines": ["M2"], "transfers": [], "notes": "Atatürk Urban Forest ...", "type": null},
      {"id": "c_ayirbas_i", "name": "Çayırbaşı", "district": "Sarıyer", "lines": ["M2"], "transfers": [], "notes": "Planned to Open After 2030", "type": "Underground"},
      {"id": "bu_yu_kdere", "name": "Büyükdere", "district": "Sarıyer", "lines": ["M2"], "transfers": [], "notes": "Planned to Open After 2030. Büyükdere jetty", "type": null},
      {"id": "sariyer", "name": "Sarıyer", "district": "Sarıyer", "lines": ["M2"], "transfers": [], "notes": "Planned to Open After 2030. Sarıyer jetty", "type": null}
    ],
    "lines": [
      {
        "id": "M2",
        "name": "M2 - Yenikapı - Hacıosman",
        "color": "#008000",
        "type": "Metro",
        "stations": [
          "sefako_y", "c_obanc_es_me", "zafer", "siyavus_pas_a", "adnan_kahveci", 
          "i_ncirli", "osmaniye", "zeytinburnu_adliye", "silivrikapi", "kocamustafapas_a",
          "yenikapi", "vezneciler", "halic_", "s_is_hane", "taksim", "osmanbey", 
          "s_is_li___mecidiyeko_y", "gayrettepe", "levent", "4_levent", 
          "sanayi_mahallesi", "i_tu_ayazag_a", "atatu_rk_oto_sanayi", 
          "daru_s_s_afaka", "haciosman",
          "c_ayirbas_i", "bu_yu_kdere", "sariyer" 
        ],
        "branches": {}
      }
      // ... potentially more lines here when you add more data
    ]
  };

  // Convert your data to Cytoscape format
  const elements = [];
  const stationNodeIds = new Set();

  // Add station nodes
  railData.stations.forEach(station => {
    if (!stationNodeIds.has(station.id)) {
      elements.push({
        group: 'nodes',
        data: {
          id: station.id,
          name: station.name,
          district: station.district,
          type: station.type, // Station type (e.g., Underground, Bridge)
          isInterchange: (station.transfers && station.transfers.length > 0) || (station.lines && station.lines.length > 1)
        }
      });
      stationNodeIds.add(station.id);
    }
  });

  // Add edges for each line
  railData.lines.forEach(line => {
    // Main line stations
    for (let i = 0; i < line.stations.length - 1; i++) {
      const sourceStation = line.stations[i];
      const targetStation = line.stations[i+1];
      // Ensure both stations exist as nodes
      if (stationNodeIds.has(sourceStation) && stationNodeIds.has(targetStation)) {
        elements.push({
          group: 'edges',
          data: {
            id: `${line.id}-${sourceStation}-${targetStation}`,
            source: sourceStation,
            target: targetStation,
            lineId: line.id,
            lineColor: line.color || '#ccc', // Default color if not specified
            lineType: line.type // e.g., Metro, Tram
          }
        });
      } else {
        console.warn(`Skipping edge for line ${line.id}: Station ${sourceStation} or ${targetStation} not found in nodes.`);
      }
    }
    // Add edges for branches if any (you'll need to populate railData.lines.branches)
    if (line.branches) {
      for (const branchName in line.branches) {
        const branchStations = line.branches[branchName];
        for (let i = 0; i < branchStations.length - 1; i++) {
          const sourceStation = branchStations[i];
          const targetStation = branchStations[i+1];
           if (stationNodeIds.has(sourceStation) && stationNodeIds.has(targetStation)) {
            elements.push({
              group: 'edges',
              data: {
                id: `${line.id}-${branchName}-${sourceStation}-${targetStation}`,
                source: sourceStation,
                target: targetStation,
                lineId: line.id,
                branchName: branchName,
                lineColor: line.color || '#ccc',
                lineType: line.type
              }
            });
          } else {
            console.warn(`Skipping edge for branch ${branchName} of line ${line.id}: Station ${sourceStation} or ${targetStation} not found.`);
          }
        }
      }
    }
  });

  var cy = cytoscape({
    container: document.getElementById('cy'),
    elements: elements,
    style: [
      {
        selector: 'node',
        style: {
          'background-color': '#666',
          'label': 'data(name)',
          'font-size': '10px',
          'text-valign': 'bottom',
          'text-halign': 'center',
          'text-margin-y': '3px',
          'width': '8px', // Smaller default size
          'height': '8px',
          'border-width': 1.5,
          'border-color': '#333'
        }
      },
      {
        selector: 'node[isInterchange="true"]',
        style: {
          'background-color': '#fff',
          'border-color': '#000',
          'border-width': 2,
          'width': '12px', // Slightly larger for interchanges
          'height': '12px',
          'shape': 'ellipse'
        }
      },
      {
        selector: 'edge',
        style: {
          'width': 3,
          'line-color': 'data(lineColor)', // Use line color from data
          'curve-style': 'bezier', // Spring layout works well with bezier
          'target-arrow-shape': 'none',
          'opacity': 0.8
        }
      }
    ],
    layout: {
      name: 'fcose', // Fast CoSE layout - good spring layout
      animate: true, // Animate layout
      idealEdgeLength: 100, // Adjust as needed
      nodeRepulsion: 4500,  // How much nodes push each other apart
      gravity: 80,          // Pulls nodes towards the center
      numIter: 2500,        // More iterations for better stability
      tile: true,           // Whether to tile disconnected components
      tilingPaddingVertical: 30,
      tilingPaddingHorizontal: 30,
      fit: true,            // Fit the viewport to the graph
      padding: 50           // Padding around the graph
    }
  });

  // Basic interaction: show station ID on click
  cy.on('tap', 'node', function(evt){
    var node = evt.target;
    console.log('Tapped ' + node.id() + ' (' + node.data('name') + ')');
    document.getElementById('station-info').textContent = `ID: ${node.id()}\nName: ${node.data('name')}\nDistrict: ${node.data('district') || 'N/A'}`;
  });

</script>

</body>
</html>